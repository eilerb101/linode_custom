# OpenSense HA Deployment on Linode
## Opensense HA Deployment leverages the following components on Linode
- You can ignore the 00- & 70- files, they are there for reference and are built into the qcow2 images.
- 1 Placement Group
- 2 VLANs
- 2 Instances with public Interfaces
- These 2 qcow2 OPNSense Images:
  - https://chicago-isos.us-ord-1.linodeobjects.com/Workspot%2Factive-112025-rev1.qcow2
  - https://chicago-isos.us-ord-1.linodeobjects.com/Workspot%2Fstandby-112025-rev1.qcow2
- A Linode Object Storage Bucket
  - A qcow2 image for OPNSense Active Instance
    - Startup script in /usr/local/etc/rc.syshook.d/start
    - The Linode Metadata service for LAN, WAN and BGP reconfiguration
    - This script is provided here for reference, there is nothing to do with it.
  - A qcow2 image for OPNSense Standby Instance
    - Startup script in /usr/local/etc/rc.syshook.d/start
    - The Linode Metadata service for LAN, WAN and BGP reconfiguration
    - This script is provided here for reference, there is nothing to do with it.
- Linode IP Sharing from Active to Standby
- A single Stackscript for Alpine 3.22 that images the Linode with the OPNSense qcow2 images
- A Single bash script (debian based) to create the instances and send data to the Stackscript

## Directions for use:
- Download the Stackscript and import it into your Linode stackscripts for use with Alpine 3.22 images. Make note of the stackscript ID
- Download opnsense_ha_deploy.sh on to a debian based system with jq and curl
- `chmod +x opnsense_ha_deploy.sh`
- Download opnsense.config
- `vi opnsense.config` and make the following changes:
  - Select a Linode Region, the only requirement is that it supports VLAN and IP Sharing. This is where your HA pair will be deployed in a placement group.
  - Give it a label, this will be the prefix of your instance within Linode
  - Give the pair a tag, this will help you find them in the UI or API.
  - The root pass is not super important, this root pass will only be for the bootstrapping of the image. So it will *NOT* be the root pass of your Firewall pair
    - **The root pass of your firewall pair will be L1n0d3 - CHANGE THIS!!**
  - Select you instance type, I would not suggest shared or GPU for this purpose
  - fill in your minimum RAM in GB and minimum vCPU, the script will use the smallest instance that meets both needs
  - Enter your stack script ID from the Linode platform. This is the ID of the script you uploaded.
  - Create a VLAN tag for your LAN
  - Give a CIDR in proper notation (n.n.n.n/n) for your LAN, the OPNSense devices will use this to determine their own IPs, and the DHCP range
    - Active will be the network address plus 2
    - Standby will be the network address plus 3
    - The shared CARP address on the LAN side will be the network address plus 1
    - The DHCP range for your clients will be 10 above the network ID and the range will stop 5 below the broadcast
- `Esc` then `:x` to save the file and exit
- last, ensure you have a proper token with rights to deploy instances, create vlans, manage ips, create keys and access object storage and create a var token with `export token=yourlinodepersonalaccesstoken` 
- Now run the script with a `./opnsense_deploy_ha.sh`
- Access your instances on HTTPS port 8087. If primary fails, the secondary will use the IP of the primary as well.
