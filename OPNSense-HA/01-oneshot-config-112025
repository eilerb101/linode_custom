#!/bin/sh
# Only run if marker exists
if [ ! -f /runonce ]; then
    exit 0
fi
# Metadata-driven OPNsense Configuration Script
# Place in: /usr/local/etc/rc.syshook.d/start/
CONFIG_FILE="/conf/config.xml"
BACKUP_FILE="/conf/config.xml.backup"
LOG_TAG="metadata-config"
KEY="ZKKyN2JMPrrRHNIAaoDefTLGsg64JmixDOYlJuV6SIExVYugq0KaJipJOv3+WlqAn8ghT1qNGuo3JwT8"
SECRET="AEbaHZ4OC28GsUHBKqI3oiBp8xE2TwAESygbr5q5n2e12FTujQpPvgGV0UYAHlMOVOTilzrT7ADBhb0f"


# Function to log messages
log_msg() {
    logger -t "$LOG_TAG" "$1"
    echo "$1"
}

# Function to calculate network address from IP/CIDR
calculate_network() {
    local ip=$1
    local bits=$2
    local IFS='.'
    set -- $ip
    local ip1=$1 ip2=$2 ip3=$3 ip4=$4
    
    # Calculate mask
    local mask=$((0xffffffff << (32 - bits) & 0xffffffff))
    local m1=$(( (mask >> 24) & 0xff ))
    local m2=$(( (mask >> 16) & 0xff ))
    local m3=$(( (mask >> 8) & 0xff ))
    local m4=$(( mask & 0xff ))
    
    # Calculate network address
    local n1=$(( ip1 & m1 ))
    local n2=$(( ip2 & m2 ))
    local n3=$(( ip3 & m3 ))
    local n4=$(( ip4 & m4 ))
    
    echo "${n1}.${n2}.${n3}.${n4}:${m1}.${m2}.${m3}.${m4}"
}

# Function to calculate broadcast address
calculate_broadcast() {
    local ip=$1
    local bits=$2
    local IFS='.'
    set -- $ip
    local ip1=$1 ip2=$2 ip3=$3 ip4=$4
    
    # Calculate inverse mask
    local mask=$((0xffffffff << (32 - bits) & 0xffffffff))
    local inv_mask=$((~mask & 0xffffffff))
    
    # Calculate broadcast
    local host_mask=$((0xffffffff << (32 - bits) & 0xffffffff))
    local n1=$(( (ip1 & (host_mask >> 24 & 0xff)) | (inv_mask >> 24 & 0xff) ))
    local n2=$(( (ip2 & (host_mask >> 16 & 0xff)) | (inv_mask >> 16 & 0xff) ))
    local n3=$(( (ip3 & (host_mask >> 8 & 0xff)) | (inv_mask >> 8 & 0xff) ))
    local n4=$(( (ip4 & (host_mask & 0xff)) | (inv_mask & 0xff) ))
    
    echo "${n1}.${n2}.${n3}.${n4}"
}

# Function to add to last octet
add_to_ip() {
    local ip=$1
    local add=$2
    local IFS='.'
    set -- $ip
    echo "${1}.${2}.${3}.$(($4 + add))"
}

log_msg "Starting metadata configuration..."

# Backup existing config
cp "$CONFIG_FILE" "$BACKUP_FILE"

# Get metadata token
log_msg "Fetching metadata token..."
TOKEN=$(curl -s --max-time 10 -X PUT -H 'Metadata-Token-Expiry-Seconds: 3600' http://[fd00:a9fe:a9fe::1]/v1/token)

if [ -z "$TOKEN" ]; then
    log_msg "ERROR: Failed to obtain metadata token"
    exit 1
fi

log_msg "Token obtained successfully"

# Get network information
log_msg "Fetching network metadata..."
NETWORK_DATA=$(curl -s --max-time 10 -H "Metadata-Token: $TOKEN" http://[fd00:a9fe:a9fe::1]/v1/network)

if [ -z "$NETWORK_DATA" ]; then
    log_msg "ERROR: Failed to fetch network metadata"
    exit 1
fi

# Extract first IPAM address (CIDR)
CIDR=$(echo "$NETWORK_DATA" | awk -F': ' '/interfaces\.ipam_address/ {print $2; exit}')

if [ -z "$CIDR" ]; then
    log_msg "ERROR: No IPAM address found in metadata"
    exit 1
fi

log_msg "Found CIDR: $CIDR"

# Split CIDR into IP and BITS
IP=$(echo "$CIDR" | cut -d'/' -f1)
BITS=$(echo "$CIDR" | cut -d'/' -f2)

log_msg "IP: $IP, BITS: $BITS"

# Calculate network and mask
CALC_RESULT=$(calculate_network "$IP" "$BITS")
NETWORK=$(echo "$CALC_RESULT" | cut -d':' -f1)
MASK=$(echo "$CALC_RESULT" | cut -d':' -f2)

log_msg "NETWORK: $NETWORK, MASK: $MASK"

# Calculate IP addresses
ROUTER=$(add_to_ip "$NETWORK" 1)
ROUTER_A=$(add_to_ip "$NETWORK" 2)
ROUTER_B=$(add_to_ip "$NETWORK" 3)
RDS=$(add_to_ip "$NETWORK" 4)
START=$(add_to_ip "$NETWORK" 10)

# Calculate END (broadcast - 6)
BROADCAST=$(calculate_broadcast "$IP" "$BITS")
END=$(add_to_ip "$BROADCAST" -6)

log_msg "ROUTER: $ROUTER"
log_msg "ROUTER_A: $ROUTER_A"
log_msg "ROUTER_B: $ROUTER_B"
log_msg "RDS: $RDS"
log_msg "START: $START"
log_msg "END: $END"

# Get region
log_msg "Fetching region metadata..."
INSTANCE_DATA=$(curl -s --max-time 10 -H "Metadata-Token: $TOKEN" http://[fd00:a9fe:a9fe::1]/v1/instance)
REGION=$(echo "$INSTANCE_DATA" | awk -F': ' '/region/ {print $2}')

if [ -z "$REGION" ]; then
    log_msg "ERROR: Failed to fetch region"
    exit 1
fi

# Normalize region to lowercase
REGION=$(echo "$REGION" | tr '[:upper:]' '[:lower:]')
log_msg "Region: $REGION"

# Get active IPv4
ACTIVEIP=$(echo "$NETWORK_DATA" | awk -F': ' '/ipv4\.public/ {print $2; exit}')

# Remove /32 suffix if present
ACTIVEIP=$(echo "$ACTIVEIP" | cut -d'/' -f1)
log_msg "Active IP: $ACTIVEIP"

# Check for shared IP
SHAREDIP=$(echo "$NETWORK_DATA" | awk -F': ' '/ipv4\.shared/ {print $2; exit}')

if [ -n "$SHAREDIP" ]; then
    MODE="standby"
    SHAREDIP=$(echo "$SHAREDIP" | cut -d'/' -f1)
    log_msg "Shared IP found: $SHAREDIP, MODE: standby"
else
    MODE="active"
    log_msg "No shared IP found, MODE: active"
fi

# Set mode dependent vars
if [ "$MODE" = "standby" ]; then
 # Calculate gateway from SHAREDIP (first 3 octets + .1)
    HOSTNAME="${REGION}-B"
    LAN_IP=${ROUTER_B}
else
 # Calculate gateway from ACTIVEIP (first 3 octets + .1)
    HOSTNAME="${REGION}-A"
    LAN_IP=${ROUTER_A}
fi

###MODIFYING CONFIG DIRECTLY BELOW
log_msg "Updating configuration file..." 
# Create temporary file for modifications
TMP_FILE=$(mktemp)
cp "$CONFIG_FILE" "$TMP_FILE"
    
# HOSTNAME CHANGES 
sed -i '' "/<system>/,/<\/system>/ s|<hostname>[^<]*</hostname>|<hostname>${HOSTNAME}</hostname>|" "$TMP_FILE"
sed -i '' "/<system>/,/<\/system>/ s|<domain>[^<]*</domain>|<domain>cloudpc.workspot.com</domain>|" "$TMP_FILE"
#####DHCP CONFIG CHANGES
# DHCP start address
sed -i '' "s|<start_addr>[^<]*</start_addr>|<start_addr>${START}</start_addr>|" "$TMP_FILE"
# DHCP end address
sed -i '' "s|<end_addr>[^<]*</end_addr>|<end_addr>${END}</end_addr>|" "$TMP_FILE"
# Subnet mask
sed -i '' "s|<subnet_mask>[^<]*</subnet_mask>|<subnet_mask>${MASK}</subnet_mask>|" "$TMP_FILE"
# DHCP option 3 (gateway) - need to match the specific UUID
sed -i '' "/<dhcp_options uuid=\"3897f4f2-9e7f-46dd-a57e-108f7abae90c\">/,/<\/dhcp_options>/ s|<value>[^<]*</value>|<value>${ROUTER}</value>|" "$TMP_FILE"
# DHCP option 6 (DNS) - need to match the specific UUID
sed -i '' "/<dhcp_options uuid=\"8cbc2590-37bf-467c-8a38-7526b9f0890f\">/,/<\/dhcp_options>/ s|<value>[^<]*</value>|<value>${ROUTER}</value>|" "$TMP_FILE"

###Compare to current configuration
# Compare TMP_FILE with original config
if cmp -s "$TMP_FILE" "$CONFIG_FILE"; then
    echo "No configuration changes detected. Discarding temp file."
    rm -f "$TMP_FILE"
    config_changed=0
else
    echo "Configuration changes detected. Updating config."
    mv "$TMP_FILE" "$CONFIG_FILE"
    config_changed=1
fi
if [ "$config_changed" = "1" ]; then
    echo "Reloading all services..."
    /usr/local/etc/rc.reload_all
else
    echo "No reload required."
fi
log_msg "Configuration updated successfully"
log_msg "Summary:"
log_msg "  This Firewall is: $HOSTNAME"
log_msg "  Mode: $MODE"
log_msg "  Network: $NETWORK"
log_msg "  DHCP Range: $START - $END"
log_msg "Metadata configuration complete"

###Delete marker
rm -f /runonce

exit 0
